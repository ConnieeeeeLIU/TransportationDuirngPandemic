# Results


### Number of daily trips people make nationally.

Time series plot
```{r setup}
library(tidyverse)
library(dplyr)
library(usmap)
library(ggplot2)
library(lubridate)
library(reshape)
```

```{r time series, fig.height = 6, fig.width = 10}
# r, fig.height = 6, fig.width = 10
national_data <- readr::read_csv("data/clean/National.csv", 
                            col_types = cols(
  .default = col_double(),
  Level = col_character(),
  Date = col_date(format = ""),
  `State FIPS` = col_character(),
  `State Postal Code` = col_character(),
  `County FIPS` = col_character(),
  `County Name` = col_character(),
  `Row ID` = col_character()
))


#national_data <- dplyr::filter(national_data, Date >= "2019-04-01")

national_weekly <- national_data %>%
  group_by(Year = year(Date),
           Week = week(Date)) %>%
  summarize(AvgWeeklytrips = mean(`Number of Trips`)) %>%
  mutate(Date = as.Date("2018-12-27")+
           365*(Year-2019)+
           7*(Week))

ggplot(national_data, aes(Date, `Number of Trips`/1000000)) + 
    geom_line(color = "grey50") + 
    geom_line(data = national_weekly,
              aes(Date, AvgWeeklytrips/1000000),
              color = 'blue', lwd = 1.5)+
    geom_smooth(method = "loess", span = .5, se = FALSE, color = 'deeppink') +
    annotate('text', x = as.Date('2020-12-15'),
             y = 1600, label = 'average weekly trips',
             color = 'blue', hjust = 0) +
    annotate('segment', x = as.Date('2020-11-28'),
             xend = as.Date('2020-12-11'), y = 1600,
             yend = 1600, color = 'blue', lwd = 1.5) +
    annotate('text', x = as.Date('2020-12-15'),
             y = 1540, label = 'smoothed daily trips',
             color = 'deeppink', hjust = 0) +
    annotate('segment', x = as.Date('2020-11-28'),
             xend = as.Date('2020-12-11'), y = 1540,
             yend = 1540, color = 'deeppink', lwd = 1.5) +  
    annotate('rect', xmin = as.Date('2020-03-13'), xmax = as.Date('2021-03-20'),
             ymin = -Inf, ymax = Inf, fill = 'wheat',
             alpha = .2) +
    ggtitle("Number of trips(National) \n (in millions)") + 
    labs(x = "Date", y = "Number of trips (in millions)") +
    theme_bw(16)
```

### plot for trip length before and after Covid-19

```{r hist}
library(reshape2)
national_data <- readr::read_csv("data/clean/National.csv", 
                            col_types = cols(
  .default = col_double(),
  Level = col_character(),
  Date = col_date(format = ""),
  `State FIPS` = col_character(),
  `State Postal Code` = col_character(),
  `County FIPS` = col_character(),
  `County Name` = col_character(),
  `Row ID` = col_character()
))

national_data$`Number of Trips >= 50` <- national_data$`Number of Trips 50-100` + national_data$`Number of Trips 100-250` + national_data$`Number of Trips 250-500` + national_data$`Number of Trips >=500`

national_data_part <- national_data[,11:16]
national_data_part$`Number of Trips >= 50`<- national_data$`Number of Trips >= 50`
national_data_part$Date <- national_data$Date
national_data_part$covid <- ifelse(national_data_part$Date > as.Date('2020-04-01'), "after", "before")

mean_national_data <- melt(national_data_part, id.vars = c("Date","covid"),
                           variable.name='distance',
                           value.name='Freq') 
mean_national_data <- mean_national_data %>%
  group_by(covid, distance) %>%
  summarize(Freq = sum(Freq))

ggplot(mean_national_data) +
      geom_col(aes(x = covid, y = Freq/1000000, fill = distance)) +  
  scale_fill_brewer(type = "qual", palette = "PRGn") +
  ggtitle("Trips before and after pandemic")  +
  xlab("Covid") + ylab("Number of trips (in millions)") + 
  theme_bw()

```

### Scatterplot: Overview of Transportation and CovID-19
```{r scatterplot, eval = FALSE}
library(covid19.analytics)
library(coronavirus)
library(reshape)
# Load time-series of total confirmed data
# 2020-01-23 ~ 2021-02-01 offline data
confirmed_ts <- covid19.data("ts-confirmed")
confirmed_ts <- dplyr::filter(confirmed_ts, Country.Region == "US")
# Get daily new cases
confirmed_ts <- growth.rate(confirmed_ts, staticPlt = FALSE)[['Changes']]

national_confirmed <- melt(confirmed_ts, id.vars = c('geo.loc'),
                           variable.name='Date',
                           value.name='Confirmed')
national_confirmed <- national_confirmed[, c('Date', 'Confirmed')] %>%  
  mutate(Date = as.Date(Date))

national_all <- merge(national_data, national_confirmed, by="Date")

#ggplot(national_all, aes(x = Confirmed, y = `Number of Trips`)) +
 # geom_point() +
 # geom_smooth() # "method = lm" to show linear regression result, but it seems not very linear 

# Find outlier through boxplot
#ggplot(national_all, aes(y=Confirmed)) +
  #geom_boxplot()

# Do regression again with confirmed cases under 150000
ggplot(dplyr::filter(national_all, Confirmed<150000), aes(x = Confirmed, y = `Number of Trips`)) +
  geom_point() + 
  geom_smooth(method = lm)
```

```{r, eval = FALSE}
# A helper plot to see trend of confirmed cases
ggplot(data=national_all, aes(x=Date, y=Confirmed))+
  geom_line()
```

### multiple Cleveland dot plot

```{r cleveland, fig.height = 6, fig.width = 10}
library(covid19.analytics)
library(coronavirus)
library(tidyverse)
library(dplyr)
library(ggplot2)
library(reshape2)

state_data <- readr::read_csv("data/clean/State.csv")
state_data <- dplyr::filter(state_data, Date >= "2020-04-01") # to be changed if start date changes
stay_per_state <- state_data %>% 
  group_by(`State Postal Code`) %>% 
  summarize(mean_stay = mean(`Population Staying at Home`), mean_notstay = mean(`Population Not Staying at Home`))

stay_per_state$stay_per <- stay_per_state$mean_stay/(stay_per_state$mean_notstay+stay_per_state$mean_stay)

colnames(stay_per_state) <- c("state","mean_stay","mean_notstay","stay_per"  )
#stay_per_state_rename <- stay_per_state %>% rename(state=`State Postal Code`)


covid_data <- covid19.data()
covid_data <- dplyr::filter(covid_data, Country_Region == "US")

covid_sum <- covid_data %>% 
  group_by(`Province_State`) %>% 
  summarize(sum_confirmed = sum(Confirmed), sum_death = sum(Deaths))

covid_sum$state <- state.abb[match(covid_sum$Province_State,state.name)]
covid_sum[10,4] = 'DC' #Columbia District can not be matched with above function
covid_sum <- dplyr::filter(covid_sum, state %in% stay_per_state$state)

mean_per_state <- state_data %>% 
  group_by(`State Postal Code`) %>% 
  summarize(mean_stay = mean(`Population Not Staying at Home`), mean_num_trips = mean(`Number of Trips`))

#mean_per_state<-mean_per_state %>% 
#  rename(state = `State Postal Code`)
colnames(mean_per_state) <- c("state","mean_stay","mean_num_trips")

covid_trip_data = merge(x = mean_per_state, y = covid_sum, by.x = "state", by.y = "state")

# create a theme for dot plots, which can be reused
theme_dotplot <- theme_bw(14) +
    theme(axis.text.y = element_text(size = rel(.5)),
        axis.ticks.y = element_blank(),
        axis.title.x = element_text(size = rel(.75)),
        panel.grid.major.x = element_blank(),
        panel.grid.major.y = element_line(size = 1),
        panel.grid.minor.x = element_blank())

options(scipen = 9)

ggplot(covid_trip_data) +
  geom_point(aes(mean_num_trips/100, reorder(state, mean_num_trips), color = 'Average number of trips')) +
  geom_point(aes(sum_confirmed, reorder(state, mean_num_trips), color = 'Sum of confirmed case')) +
  ggtitle("Number of trips and confirmed case", sub = "sorted by trips value") + ylab("State") +
  theme_dotplot
```

Cleveland dot plot of number of trips before and after pandemic
```{r c 2, fig.height = 6, fig.width = 10}
library(covid19.analytics)
library(coronavirus)
library(tidyverse)

state_data <- readr::read_csv("data/clean/State.csv")
#state_data <- state_data %>% 
#  rename(state = `State Postal Code`)


colnames(state_data)[5] <- 'state'

state_data_after <- dplyr::filter(state_data, Date >= "2020-04-01") # to be changed if start date changes
state_data_before <- dplyr::filter(state_data, Date < "2020-04-01")

mean_per_state_before <- state_data_before %>% 
  group_by(state) %>% 
  summarize(mean_nstay_before = mean(`Population Not Staying at Home`), mean_num_trips_before = mean(`Number of Trips`))

mean_per_state_after <- state_data_after %>% 
  group_by(state) %>% 
  summarize(mean_nstay_after = mean(`Population Not Staying at Home`), mean_num_trips_after = mean(`Number of Trips`))

#mean_per_state<-mean_per_state %>% 
#  rename(state = `State Postal Code`)

compare_trip_data = merge(x = mean_per_state_before, y = mean_per_state_after, by.x = "state", by.y = "state")

# create a theme for dot plots, which can be reused
theme_dotplot <- theme_bw(14) +
    theme(axis.text.y = element_text(size = rel(.5)),
        axis.ticks.y = element_blank(),
        axis.title.x = element_text(size = rel(.75)),
        panel.grid.major.x = element_blank(),
        panel.grid.major.y = element_line(size = 1),
        panel.grid.minor.x = element_blank())

options(scipen = 9)

ggplot(compare_trip_data) +
  geom_point(aes(mean_num_trips_before/1000, reorder(state, mean_num_trips_before), color = 'Average trips before pandamic')) +
  geom_point(aes(mean_num_trips_after/1000, reorder(state, mean_num_trips_before), color = 'Average trips after pandamic')) +
  ggtitle("Number of trips before and after pandamic", sub = "sorted by before") + ylab("State") +
  theme_dotplot

```


### Percent of people staying at home during COVID-19 pandemic.

Date after 2020-04-01
https://github.com/wmurphyrd/fiftystater
https://github.com/pdil/usmap/blob/master/resources/examples.R
```{r map, fig.height = 6, fig.width = 10}
library(tidyverse)
library(dplyr)
library(usmap)
library(ggplot2)
library(reshape2)

state_data <- readr::read_csv("data/clean/State.csv")
state_data <- dplyr::filter(state_data, Date >= "2020-04-01") # to be changed if start date changes
stay_per_state <- state_data %>% 
  group_by(`State Postal Code`) %>% 
  summarize(mean_stay = mean(`Population Staying at Home`), mean_notstay = mean(`Population Not Staying at Home`))
  
stay_per_state$stay_per <- stay_per_state$mean_stay/(stay_per_state$mean_notstay+stay_per_state$mean_stay)
#stay_per_state<-stay_per_state %>% 
#  rename(state = `State Postal Code`)
colnames(stay_per_state) <- c("state","mean_stay","mean_notstay","stay_per"  )
state_perc_map_labeled <- plot_usmap(data = stay_per_state, 
                                     values = "stay_per", labels = TRUE) + 
  scale_fill_continuous(low = "white", high = "blue", 
                        name = "Percentage of people at home", label = scales::comma) + 
  labs(title = "Percentage of people staying at home", 
       subtitle = "Percentage Estimates for people stay at home for each state after 04/2020") +
  theme(legend.position = "right")+
  theme(plot.title = element_text(size = 20, face = "bold"))

state_perc_map_labeled$layers[[2]]$aes_params$size <- 3.5
print(state_perc_map_labeled)
```
Note: Did not manage to solve the label overlap problem :(


### Heatmap of people going out in each state
```{r Heatmap, fig.width = 12, fig.height = 12}
library(covid19.analytics)
library(coronavirus)
library(dplyr)
state_data <- readr::read_csv("data/clean/State.csv")
state_data <- dplyr::filter(state_data, Date >= "2020-03-01" & Date < "2021-03-01")
state_monthly <- state_data %>%
  group_by(Year = year(Date),
           Month = month(Date),
           Day = "1",
           `State Postal Code`) %>%
  summarize(sum_stay = sum(`Population Staying at Home`), sum_notstay = sum(`Population Not Staying at Home`)) %>%
  mutate(Date = as.Date(paste(Year, Month, Day, sep="-")))
state_monthly$stay_per <- state_monthly$sum_stay/(state_monthly$sum_notstay+state_monthly$sum_stay)
state_monthly$notstay_per <- state_monthly$sum_notstay/(state_monthly$sum_notstay+state_monthly$sum_stay)
#state_monthly<-state_monthly %>% 
#  rename(state = `State Postal Code`)
colnames(state_monthly)[4] <- 'state'

ggplot(state_monthly, aes(x=Date, y=reorder(state, notstay_per))) +
  geom_tile(aes(fill = notstay_per), colour = "white") +
  theme(panel.background = element_blank(),axis.line = element_line(colour="black"))+
  theme(axis.ticks.x = element_blank())+
  theme(axis.ticks.y = element_blank())+
  theme(axis.title.y=element_blank())+
  theme(axis.title.x=element_blank())+
  theme(legend.title=element_blank())+
  scale_fill_gradient2(low = "steelblue", mid = "white", high = "red", midpoint = 0.7) +
  ggtitle(label = "Percent of people travelling in each state over months")
```

### Alluvial chart showing type of travelling in terms of distance
```{r alluvial, fig.width = 12, fig.height = 12}
library(ggalluvial)
library(dplyr)
state_data$`Number of Trips >= 50` <- state_data$`Number of Trips 50-100` + state_data$`Number of Trips 100-250` + state_data$`Number of Trips 250-500` + state_data$`Number of Trips >=500`
state_agg <- state_data[-which(colnames(state_data) %in% c("X1", "Level", "State FIPS", "County FIPS", "County Name", "Population Staying at Home", "Population Not Staying at Home", "Row ID","Number of Trips", "Number of Trips 50-100", "Number of Trips 100-250", "Number of Trips 250-500", "Number of Trips >=500"))]
state_agg <- melt(state_agg, id.vars = c('State Postal Code','Date'),
                           variable.name='Trips in Different Distance',
                           value.name='Freq') 
#%>% rename(state = `State Postal Code`)
colnames(state_agg)[1] <- 'state'

state_agg <- state_agg %>%
  group_by(state,
           `Trips in Different Distance`) %>%
  summarize(Freq = sum(Freq))

# Show alluvial chart of top 5 states where most people travelling around
state_agg <- dplyr::filter(state_agg, state %in% c('MS', 'AL', 'AR', 'SC', 'LA'))
ggplot(state_agg, aes(y = Freq, axis1 = state, axis2 = `Trips in Different Distance`))+
  geom_alluvium(aes(fill = state), width = 1/12) +
  geom_stratum(width = 1/12, fill = "black", color = "grey") +
  geom_label(stat = "stratum", aes(label = after_stat(stratum))) +
  scale_x_discrete(limits = c("State", "Trips in Different Distance"), expand = c(.05, .05)) +
  scale_fill_brewer(type = "qual", palette = "Set1") +
  ggtitle("How far does people travel during pandemic")
```

### Treemap for top five states where most people travelling around

```{r Treemap, fig.height = 6, fig.width = 10, eval=FALSE}
library(treemap)
treemap(state_agg,
        index=c('state','Trips in Different Distance'),
        vSize="Freq",
        type="index",
        palette = "Pastel1",
        title = 'Treemap of state and number of trips',
        fontsize.title = 14, 
        fontsize.labels = 8, 
        fontsize.legend = 8,
        align.labels = list(c('center','center'), c('right','top'))) 
```
```{r treemap, fig.height = 4, fig.width = 6, include = FALSE}
#devtools::install_github("timelyportfolio/d3treeR")
library(d3treeR)
library(treemap)
treemap <- treemap(state_agg,
        index=c('state','Trips in Different Distance'),
        vSize="Freq",
        type="index",
        palette = "Pastel1",
        title = 'Treemap of state and number of trips',
        fontsize.title = 14, 
        fontsize.labels = 8, 
        fontsize.legend = 8,
        align.labels = list(c('center','center'), c('right','top'))) 
```
Interactive! https://www.data-to-viz.com/graph/treemap.html

```{r interactive treemap}
# make it interactive ("rootname" becomes the title of the plot):
d3tree2(treemap ,  rootname = 'Treemap of state and number of trips' )

```


